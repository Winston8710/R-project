---
title: TF56_è³‡æ–™åˆ‡å‰²èˆ‡å»ºç«‹æ¨¡å‹ 
author: è”¡ç§‰è¾°
date: "`r Sys.time()`"
output:
  html_document:
    highlight: pygments
    theme: flatly
    css: ../etc/style.css
---

<br>

### è³‡æ–™æº–å‚™æµç¨‹

<center>

![Fig-3: Data Preparation](fig/preparation.jpg)

</center>

<hr>

### Preparing The Predictors (X)
```{r echo=T, message=F, cache=F, warning=F}
rm(list=ls(all=TRUE))
pacman::p_load(magrittr,latex2exp,Matrix,dplyr,tidyr,ggplot2,caTools,plotly)
load("data/tf0.rdata")
```

##### The Demarcation Date
Remove data after the demarcation date
```{r}
feb01 = as.Date("2001-02-01")
Z = subset(Z0, date < feb01)    # 618212
```

##### Aggregate for the Transaction Records
```{r}
X = group_by(Z, tid) %>% summarise(
  date = first(date),  # äº¤æ˜“æ—¥æœŸ
  cust = first(cust),  # é¡§å®¢ ID
  age = first(age),    # é¡§å®¢ å¹´é½¡ç´šåˆ¥
  area = first(area),  # é¡§å®¢ å±…ä½å€åˆ¥
  items = n(),                # äº¤æ˜“é …ç›®(ç¸½)æ•¸
  pieces = sum(qty),          # ç”¢å“(ç¸½)ä»¶æ•¸
  total = sum(price),         # äº¤æ˜“(ç¸½)é‡‘é¡
  gross = sum(price - cost)   # æ¯›åˆ©
  ) %>% data.frame  # 88387
```

```{r}
summary(X)
```

##### Check Quantile and Remove Outlier 
```{r}
sapply(X[,6:9], quantile, prob=c(.999, .9995, .9999))
```

```{r}
X = subset(X, items<=64 & pieces<=98 & total<=11260) # 88387 -> 88295
```

##### Aggregate for Customer Records
```{r}
d0 = max(X$date) + 1
A = X %>% mutate(
  days = as.integer(difftime(d0, date, units="days"))
  ) %>% 
  group_by(cust) %>% summarise(
    r = min(days),      # recency
    s = max(days),      # seniority
    f = n(),            # frquency
    m = mean(total),    # monetary
    rev = sum(total),   # total revenue contribution
    raw = sum(gross),   # total gross profit contribution
    age = age[1],       # age group
    area = area[1],     # area code
  ) %>% data.frame      # 28584
nrow(A)
```
<br><br><hr>

### Preparing the Target Variables (Y)

##### Aggregate Feb's Transaction by Customer
```{r}
feb = filter(X0, date>= feb01) %>% group_by(cust) %>% 
  summarise(amount = sum(total))  # 16900
```

##### The Target for Regression - `A$amount`
Simply a Left Joint
```{r}
A = merge(A, feb, by="cust", all.x=T)
```

##### The Target for Classification - `A$buy`
```{r}
A$buy = !is.na(A$amount)
table(A$buy, !is.na(A$amount))
```

##### Summary of the Dataset
```{r}
summary(A)
```
<br><br><hr>

### Preparing Train & Test Datasets

##### Train & Test Dataset
```{r}
X = subset(X, cust %in% A$cust & date < as.Date("2001-02-01"))
Z = subset(Z, cust %in% A$cust & date < as.Date("2001-02-01"))
set.seed(2018); spl = sample.split(A$buy, SplitRatio=0.7) 
c(nrow(A), sum(spl), sum(!spl))
```

```{r fig.height=3, fig.width=7}
cbind(A, spl) %>% filter(buy) %>%  
  ggplot(aes(x=log(amount))) + geom_density(aes(fill=spl), alpha=0.5)
```


```{r}
A2 = subset(A, buy) %>% mutate_at(c("m","rev","amount"), log10)
n = nrow(A2)
set.seed(2018); spl2 = 1:n %in% sample(1:n, round(0.7*n))
c(nrow(A2), sum(spl2), sum(!spl2))
```

```{r fig.height=3, fig.width=7}
cbind(A2, spl2) %>% 
  ggplot(aes(x=amount)) + geom_density(aes(fill=spl2), alpha=0.5)
```


```{r}
save(Z, X, A, spl, spl2, file="data/tf3.rdata")
```
<br>

<center>

![Fig-4: Data Spliting](fig/spliting.jpg)

</center>
##### Spliting for Classification 
```{r}
TR = subset(A, spl)
TS = subset(A, !spl)
```
<br><hr>

### Classification Model
```{r}
glm1 = glm(buy ~ ., TR[,c(2:9, 11)], family=binomial()) 
summary(glm1)
```

```{r}
pred =  predict(glm1, TS, type="response")
cm = table(actual = TS$buy, predict = pred > 0.5); cm
```

```{r}
acc.ts = cm %>% {sum(diag(.))/sum(.)}
c(1-mean(TS$buy) , acc.ts)  # 0.69998
```

```{r}
colAUC(pred, TS$buy)        # 0.7556
```
<br><hr>

### Regression Model
```{r}
A2 = subset(A, A$buy) %>% mutate_at(c("m","rev","amount"), log10)
TR2 = subset(A2, spl2)
TS2 = subset(A2, !spl2)
```

```{r}
lm1 = lm(amount ~ ., TR2[,c(2:6,8:10)])
summary(lm1)
```

```{r}
r2.tr = summary(lm1)$r.sq
SST = sum((TS2$amount - mean(TR2$amount))^ 2)
SSE = sum((predict(lm1, TS2) -  TS2$amount)^2)
r2.ts = 1 - (SSE/SST)
c(R2train=r2.tr, R2test=r2.ts)
```
<br><hr>

### è£½ä½œè®Šæ•¸ã€æ”¹é€²æ¨¡å‹

<br><hr>
###åŠ å…¥å“é …æ•¸èˆ‡é¡§å®¢åˆ†ç¾¤
```{r}
A00 = X %>% mutate(
  days = as.integer(difftime(d0, date, units="days"))
  ) %>% 
  group_by(cust) %>% summarise(
    r = min(days),s = max(days), f = n(), m = mean(total), rev = sum(total), raw = sum(gross), age = age[1],  area = area[1], items = mean(items), period=s-r ) %>% data.frame      # 28584
nrow(A00)
```

```{r}
STS = c("N1","R1","R2","S1")
Status = function(rx,fx,sx,dx) {factor(
  ifelse(dx == 0,
         ifelse(rx <90  , "N1","S1"),
         ifelse( dx/fx <10 ,"R2","R1")), STS)} 
A1 = A00 %>%  mutate(group=Status(r,f,s,period))
N1 = A1 %>% filter(group=="N1")%>%pull(cust)
S1 = A1 %>% filter(group=="S1")%>%pull(cust)
R1 = A1 %>% filter(group=="R1")%>%pull(cust)
R2 = A1 %>% filter(group=="R2")%>%pull(cust)
```
##### æ•¸å€¼å‹è¿´æ­¸(ç”¨ä¾†é æ¸¬è³¼è²·é‡‘é¡) - `A$amount`
Simply a Left Joint
```{r}
A1 = merge(A1, feb, by="cust", all.x=T)
```

##### é¡åˆ¥å‹è¿´æ­¸(ç”¨ä¾†é æ¸¬å›è³¼æ©Ÿç‡) - `A$buy`
```{r}
A1$buy = !is.na(A1$amount)
table(A1$buy, !is.na(A1$amount))
```
##### Summary of the Dataset
```{r}
summary(A1)
```

```{r}
X1 = subset(X, cust %in% A1$cust & date < as.Date("2001-02-01"))
Z1 = subset(Z, cust %in% A1$cust & date < as.Date("2001-02-01"))
set.seed(2018); spl3 = sample.split(A1$buy, SplitRatio=0.7) #å°‡è³‡æ–™ç”¨éš¨æ©Ÿæ•¸é¸æ“‡å¾Œï¼Œé€²è¡Œåˆ‡å‰²
c(nrow(A1), sum(spl3), sum(!spl3))
```


```{r}
A12 = subset(A1, buy) %>% mutate_at(c("m","rev","amount"), log10)
n = nrow(A12)
set.seed(2018); spl4 = 1:n %in% sample(1:n, round(0.7*n))
c(nrow(A12), sum(spl4), sum(!spl4))
```

##### Spliting for Classification 
```{r}
TR3 = subset(A1, spl3)
TS3 = subset(A1, !spl3)
```
<br><hr>

### Classification Model
```{r}
glm2 = glm(buy ~ ., TR3[,c(2:10,12, 14)], family=binomial()) 
summary(glm2)
```

```{r}
pred2 =  predict(glm2, TS3, type="response")
cm = table(actual = TS3$buy, predict = pred2 > 0.5); cm
```

```{r}
acc.ts = cm %>% {sum(diag(.))/sum(.)}
c(1-mean(TS3$buy) , acc.ts)  # 0.7010261
```

```{r}
colAUC(pred2, TS3$buy)        # 0.7564
tsAUC2 = colAUC(pred2, y=TS3$buy, plotROC=T)
```
<br><hr>

### Regression Model
```{r}
A12 = subset(A1, A1$buy) %>% mutate_at(c("m","rev","amount"), log10)
TR4 = subset(A12, spl4)
TS4 = subset(A12, !spl4)
```

```{r}
lm2 = lm(amount ~ ., TR4[,c(2:6,8:10,12,13)])
summary(lm2)
```

```{r}
r2.tr2 = summary(lm2)$r.sq
SST2 = sum((TS4$amount - mean(TR4$amount))^ 2)
SSE2 = sum((predict(lm2, TS4) -  TS4$amount)^2)
r2.ts2 = 1 - (SSE/SST)
c(R2train2=r2.tr2, R2test2=r2.ts2)
```
<br><hr>
### é€²è¡Œé æ¸¬

<center>

![Fig-3: Prediction](fig/prediction.png)
</center>

<hr>

Aggregate data 2000-12-01 ~ 2001~02-28. 
```{r}
load("data/tf0.rdata")
d0 = max(X0$date) + 1
B = X0 %>% 
  filter(date >= as.Date("2000-12-01")) %>% 
  mutate(days = as.integer(difftime(d0, date, units="days"))) %>% 
  group_by(cust) %>% summarise(
    r = min(days),      # recency
    s = max(days),      # seniority
    f = n(),            # frquency
    m = mean(total),    # monetary
    rev = sum(total),   # total revenue contribution
    raw = sum(gross),   # total gross profit contribution
    age = age[1],       # age group
    area = area[1],     # area code
    items = mean(items), 
    period=s-r
  ) %>% data.frame      # 28584
nrow(B)
```
```{r}
STS = c("N1","R1","R2","S1")
Status = function(rx,fx,sx,dx) {factor(
  ifelse(dx == 0,
         ifelse(rx <90  , "N1","S1"),
         ifelse( dx/fx <10 ,"R2","R1")), STS)} 
B1 = B %>%  mutate(group=Status(r,f,s,period))
N1 = B1 %>% filter(group=="N1")%>%pull(cust)
S1 = B1 %>% filter(group=="S1")%>%pull(cust)
R1 = B1 %>% filter(group=="R1")%>%pull(cust)
R2 = B1 %>% filter(group=="R2")%>%pull(cust)
```


In `B`, there is a record for each customer. `B$Buy` is the probability of buying in March.
```{r}
B1$Buy = predict(glm1, B1, type="response")
```

<span style="font-size:24px">`r "\U1F4A1"`ï¼š</span>
é æ¸¬è³¼è²·é‡‘é¡æ™‚è¦è¨˜å¾—åšæŒ‡æ•¸ã€å°æ•¸è½‰æ›ï¼

```{r}
B2 = B1 %>% mutate_at(c("m","rev"), log10)
B1$Rev = 10^predict(lm1, B2)
```

```{r fig.height=2.4, fig.width=7.2}
par(mfrow=c(1,2), cex=0.8)
hist(B1$Buy)
hist(log(B1$Rev,10))
```

```{r}
save(B1, file='data/tf4.rdata')
```

```{r}
B1$Buy2 = predict(glm2, B1, type="response")
```

```{r}
B1$Rev2 = 10^predict(lm2, B2)
```

```{r fig.height=2.4, fig.width=7.2}
par(mfrow=c(1,2), cex=0.8)
hist(B1$Buy2)
hist(log(B1$Rev2,10))
hist(B1$Buy)
hist(log(B1$Rev,10))
```
```{r}
B1 %>% group_by(group)%>%summarise(buy=mean(Buy2),rev=mean(Rev2)) #å„æ—ç¾¤çš„å›è³¼æ©Ÿç‡å’Œé æœŸè³¼è²·é‡‘é¡
```
```{r}
sum(B1$raw)/sum(B1$rev) #å…¬å¸ç›®å‰ç²åˆ©ç‡
```

```{r}
g = 0.15   # (ç¨…å‰)ç²åˆ©ç‡
N = 5     # æœŸæ•¸ = 5
d = 0.1   # åˆ©ç‡ = 10%
B1$CLV = g * B1$Rev2 * rowSums(sapply(
  0:N, function(i) (B1$Buy2/(1+d))^i ) )

summary(B1$CLV) #ä¼°è¨ˆé¡§å®¢çµ‚ç”Ÿåƒ¹å€¼(CLV)
```

```{r fig.height=2.5, fig.width=7.2}
par(mar=c(2,2,3,1), cex=0.8)
hist(log(B1$CLV,10), xlab="", ylab="")
```

```{r}
# å„æ—ç¾¤çš„å¹³å‡ç‡Ÿæ”¶è²¢ç»ã€ä¿ç•™æ©Ÿç‡ã€çµ‚ç”Ÿåƒ¹å€¼
B1 %>% group_by(group) %>% summarise_at(vars(Buy2:CLV), mean)
```
###ç¹ªè£½é¡§å®¢çµ‚ç”Ÿåƒ¹å€¼å°é¡§å®¢ç‹€æ…‹åˆ†ç¾¤çš„ç›’ç‹€åœ–ã€‚
```{r}
par(mar=c(3,3,4,2), cex=0.8)
boxplot(log(CLV,10)~group, B1, main="CLV by Groups")
```
**ä¼°è¨ˆæ¯ä½é¡§å®¢çš„æ·¨æ”¶ç›Š** $\hat{R}(x)$
```{r fig.height=3, fig.width=5}
m=0.2; b=25; a=40; x=30
DP = function(x,m0,b0,a0) {m0*plogis((10/a0)*(x-b0))}
dp = pmin(1-B1$Buy2, DP(x,m,b,a))
eR = dp*B1$Rev2*g - x
hist(eR,main="é æœŸæ·¨æ”¶ç›Šåˆ†ä½ˆ",xlab="é æœŸæ·¨æ”¶ç›Š",ylab="é¡§å®¢äººæ•¸")
```
```{r fig.height=3, fig.width=7}
mm=c(0.20, 0.25, 0.15, 0.25)
bb=c(  25,   30,   15,   30)
aa=c(  40,   40,   30,   60) 
X = seq(0,60,2) 
do.call(rbind, lapply(1:length(mm), function(i) data.frame(
  Inst=paste0('Inst',i), Cost=X, 
  Gain=DP(X,mm[i],bb[i],aa[i])
  ))) %>% data.frame %>% 
  ggplot(aes(x=Cost, y=Gain, col=Inst)) +
  geom_line(size=1.5,alpha=0.5) + theme_bw() +
  ggtitle("Prob. Function: f(x|m,b,a)")
```

```{r warning=F, fig.height=8, fig.width=8}
X = seq(10, 60, 1) 
df = do.call(rbind, lapply(1:length(mm), function(i) {
  sapply(X, function(x) {
    dp = pmin(1-B1$Buy2, DP(x,mm[i],bb[i],aa[i]))
    eR = dp*B1$Rev2*g - x
    c(i=i, x=x, eR.ALL=sum(eR), N=sum(eR>0), eR.SEL=sum(eR[eR > 0]) )
    }) %>% t %>% data.frame
  })) 

df %>% 
  mutate_at(vars(eR.ALL, eR.SEL), function(y) round(y/1000)) %>% 
  gather('key','value',-i,-x) %>% 
  mutate(Instrument = paste0('I',i)) %>%
  ggplot(aes(x=x, y=value, col=Instrument)) + 
  geom_hline(yintercept=0, linetype='dashed', col='blue') +
  geom_line(size=1.5,alpha=0.5) + 
  xlab('å·¥å…·é¸é …(æˆæœ¬)') + ylab('é æœŸæ”¶ç›Š($K)') + 
  ggtitle('è¡ŒéŠ·å·¥å…·å„ªåŒ–','å‡è¨­è¡ŒéŠ·å·¥å…·çš„æ•ˆæœæ˜¯å…¶æˆæœ¬çš„å‡½æ•¸') +
    facet_wrap(~key,ncol=1,scales='free_y') + theme_bw() -> p

plotly::ggplotly(p)
```
```{r}
ci = sapply(
  list(c("N1"),c("R1"),
       c("R2"),c("S1")), 
  function(v) B1$group %in% v)  

X2 = seq(10, 60, 1) 
df = do.call(rbind, lapply(1:length(mm), function(i) {
  sapply(X2, function(x) {
    dp = pmin(1- B1$Buy2[ ci[,i] ]  , DP(x,mm[i],bb[i],aa[i]))
    eR = dp* B1$Rev2[ ci[,i] ]  *g - x
    c(i=i, x=x, eR.ALL=sum(eR), N=sum(eR>0), eR.SEL=sum(eR[eR > 0]) )
    }) %>% t %>% data.frame
  })) 

group_by(df, i) %>% top_n(1,eR.SEL)
```
<br>

<p class="qiz">
<span style="font-size:18px"> ğŸš´ è¨è«–è¡ŒéŠ·æ–¹æ¡ˆï¼š</span><br>
å¦‚æœä¸Šè¿°4çµ„å·¥å…·åƒæ•¸åˆ†åˆ¥æ˜¯4ç¨®è¡ŒéŠ·å·¥å…·å°4å€‹é¡§å®¢æ—ç¾¤çš„æ•ˆæœï¼š<br>
&emsp; â–  `I1 : N1`<br>
&emsp; â–  `I2 : R1`<br>
&emsp; â–  `I3 : R2`<br>
&emsp; â–  `I4 : S1`<br>
é‡å°é€™4å€‹é¡§å®¢æ—ç¾¤ä¹‹ä¸­é¸æ“‡è¡ŒéŠ·å°è±¡ï¼š<br>
&emsp; â–  é¸æ“‡è¡ŒéŠ·å°è±¡(`N`)<br>
&emsp; &emsp; <z>å°`N1`æ—ç¾¤ä¸­çš„`2405`ä½é¡§å®¢ï¼›</z><br>
&emsp; &emsp; <z>å°`R1`æ—ç¾¤ä¸­çš„`2554`ä½é¡§å®¢ï¼›</z><br>
&emsp; &emsp; <z>å°`R2`æ—ç¾¤ä¸­çš„`1341`ä½é¡§å®¢ï¼›</z><br>
&emsp; &emsp; <z>å°`S1`æ—ç¾¤ä¸­çš„`30`ä½é¡§å®¢ï¼Œç¸½å…±`6330`ä½é¡§å®¢åšè¡ŒéŠ·ã€‚</z><br>
&emsp; â–  è¨­å®šè¡ŒéŠ·å·¥å…·çš„é¢é¡(`x`)<br>
&emsp; &emsp; <z>å°`N1`æ—ç¾¤ç™¼é€`35å…ƒ`åƒ¹å€¼çš„æŠ˜åƒ¹åˆ¸ï¼›</z><br>
&emsp; &emsp; <z>å°`R1`æ—ç¾¤ç™¼é€`40å…ƒ`åƒ¹å€¼çš„æ»¿é¡å¤–é€å…é‹åˆ¸ï¼›</z><br>
&emsp; &emsp; <z>å°`R2`æ—ç¾¤ç™¼é€`21å…ƒ`åƒ¹å€¼çš„çµ„åˆåŒ…å„ªæƒ ï¼›</z><br>
&emsp; &emsp; <z>å°`S1`æ—ç¾¤ç™¼é€`44å…ƒ`åƒ¹å€¼çš„è©¦åƒåŒ…ã€‚</z><br>
&emsp; â–  ä¼°è¨ˆé æœŸå ±å„Ÿ(`eR.SEL`)ï¼Ÿ<br>
&emsp; &emsp; <z>é è¨ˆ`N1`æ—ç¾¤å¸¶ä¾†å ±å„Ÿç‚º`43943.6å…ƒ`ï¼›</z><br>
&emsp; &emsp; <z>é è¨ˆ`R1`æ—ç¾¤å¸¶ä¾†å ±å„Ÿç‚º`41533.04å…ƒ`ï¼›</z><br>
&emsp; &emsp; <z>é è¨ˆ`R2`æ—ç¾¤å¸¶ä¾†å ±å„Ÿç‚º`10911.4å…ƒ`ï¼›</z><br>
&emsp; &emsp; <z>é è¨ˆ`S1`æ—ç¾¤å¸¶ä¾†å ±å„Ÿç‚º`801.18å…ƒ`ï¼Œç¸½é æœŸå ±å„Ÿç‚º`97,189.22`å…ƒã€‚</z><br>
</p class="qiz"><br>

<br>




<br><br><hr>
<br><hr>

